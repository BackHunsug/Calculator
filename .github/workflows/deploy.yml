name: Java CI/CD with Docker

# 언제 이 작업을 실행할지 정의합니다.
on:
  push:
    branches: [ "main" ] # main 브랜치에 push될 때마다 실행

jobs:
  build-and-push:
    runs-on: ubuntu-latest # GitHub가 제공하는 가상 서버 (RAM 약 7GB)

    steps:
    # 1. GitHub 리포지토리의 소스 코드를 가상 서버로 가져옵니다.
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. 자바 실행 환경을 설정합니다.
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 3. Gradle에 실행 권한을 부여합니다.
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # 4. 테스트 및 빌드를 수행합니다.
    - name: Test and Build with Gradle
      run: ./gradlew clean build

    # 5. 도커 허브에 로그인합니다. (GitHub Secrets에 저장한 값 사용)
    - name: Login to Docker Hub
      if: success() # 위 빌드와 테스트가 성공했을 때만 실행
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 6. 도커 이미지를 빌드하고 푸시합니다.
    - name: Build and Push Docker Image
      if: success()
      run: |
        # 이미지 이름 형식: [도커ID]/[이미지명]:[태그]
        # 사용자님 마음대로 정하신 버전(예: 1.3)을 여기에 적습니다.
        docker build -t ${{ secrets.DOCKER_USERNAME }}/mycalc:1.3 .
        docker push ${{ secrets.DOCKER_USERNAME }}/mycalc:1.3